---
name: CI

on:
  push:
    branches:
      - main
  pull_request: ~
  workflow_dispatch: ~

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Build and start services
        run: docker compose up -d --build

      - name: Wait for app to be ready
        run: |
          echo "Waiting for app to boot..."
          for i in {1..60}; do
            if curl -sf http://localhost:8000/health > /dev/null; then
              echo "App is ready!"
              exit 0
            fi
            echo "Attempt $i/60 - waiting..."
            sleep 2
          done
          echo "App failed to boot within 120 seconds"
          docker compose logs
          exit 1

      - name: Check health endpoint
        run: curl -v --fail-with-body http://localhost:8000/health

      - name: Check home page
        run: curl -v --fail-with-body http://localhost:8000/

      - name: Check pokemon list page
        run: curl -v --fail-with-body http://localhost:8000/pokemon

      - name: Cleanup
        if: always()
        run: docker compose down -v
